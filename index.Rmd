---
title: "Rice Production"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

---

```{r lib}
library(ezids)
```

```{r pi}
#load the dataset
rice_prod <- read.csv("C:/Users/HARI/Documents/DATS6101-Team4/Rice Production Data.csv")

#display top rows of the dataset
xkabledplyhead(rice_prod, title = "Rice Production")

#summary of the dataset
summary(rice_prod)
```

```{r}
#display the shape of dataset
dim(rice_prod)
```

```{r col}
#display the column names of dataset
colnames(rice_prod)
```

```{r modify}

#defining name_map to rename the columns
name_map <- c(
  "Production..t." = "Production",
  "production__tonnes__per_capita" = "Production_per_capita(kg)",
  "Production.per.capita..kg." = "Production_per_capita(kg)",
  "Yield..t.ha." = "Yield(t/ha)",
  "Land.Use..ha." = "Land_Use",
  "area_harvested__ha__per_capita" = "Area_Harvested(ha_per_capita)",
  "Land.Use.per.capita..m.." = "Land_Use_per_Capita",
  "Imports..t." = "Imports(t)",
  "imports__tonnes__per_capita" = "Imports(t_per_capita)",
  "Imports.per.capita..kg." = "Imports_per_capita(kg)",
  "Exports..t." = "Exports(t)",
  "exports__tonnes__per_capita" = "Exports(t_per_capita)",
  "Exports.per.capita..kg." = "Exports_per_capita(kg)",
  "Domestic.supply..t." = "Domestic_Supply(t)",
  "domestic_supply__tonnes__per_capita" = "Domestic_Supply(t_per_capita)",
  "Domestic.supply.per.capita..kg." = "Domestic_Supply_per_Capita(kg)",
  "Food..t." = "Food(t)",
  "food__tonnes__per_capita" = "Food(t_per_capita)",
  "Food.per.capita..kg." = "Food_per_Capita(kg)",
  "Animal.feed..t." = "Animal_Feed(t)",
  "feed__tonnes__per_capita" = "Animal_Feed(t_per_capita)",
  "Animal.feed.per.capita..kg." = "Animal_Feed_per_Capita(kg)",
  "Other.uses..t." = "Other_Uses(t)",
  "other_uses__tonnes__per_capita" = "Other_Uses(t_per_capita)",
  "Other.uses.per.capita..kg." = "Other_uses_per_capita(kg)",
  "Supply.chain.waste..t." = "Supply_Chain_Waste(t)",
  "waste_in_supply_chain__tonnes__per_capita" = "Waste_in_supply_chain(t_per_capita)",
  "Supply.chain.waste.per.capita..kg." = "Supply_chain_waste_per_Capita(kg)",
  "Food.supply..kg.per.capita.per.year." = "Food_supply(kg_per_capita_per_day)",
  "Food.supply..g.per.capita.per.day." = "Food_supply(g_per_capita_per_day)",
  "Food.supply..kcal.per.capita.per.day." = "Food_supply(kcal_per_capita_per_day)",
  "Food.supply..Protein.g.per.capita.per.day." = "Food_supply(Protein_per_capita_per_day)",
  "Food.supply..Fat.g.per.capita.per.day." = "Food_supply(Fat_per_capita_per_day)"
)

#rename the columns based on name_map
for (old_name in colnames(rice_prod)) {
  if (old_name %in% names(name_map)) {
    colnames(rice_prod)[colnames(rice_prod) == old_name] <- name_map[old_name]
  }
}

#display the changed column names
colnames(rice_prod)
```
```{r}
# Load necessary libraries
library(dplyr)
library(ggplot2)
library(zoo)
library(stringr)

columns_of_interest <-
  c("Country", "Year", "Production", "Population", "Land_Use")

df_filtered <- rice_prod %>%
  select(columns_of_interest)

#filtering data between 1980 and 2020
df_filtered <- df_filtered[df_filtered$Year >= 1980 &
                             df_filtered$Year <= 2020, ]

#categorizing based on countries
df_filtered <- df_filtered %>%
  mutate(
    area_type = case_when(
      str_detect(Country, "FAO") ~ "Region",
      str_detect(Country, "(?i)countries") ~ "Region",
      str_detect(Country, "European Union") ~ "Region",
      str_detect(Country, "World") ~ "World",
      Country %in% c(
        "North America",
        "South America",
        "Asia",
        "Africa",
        "Europe",
        "Oceania",
        "Antarctica"
      ) ~ "Continent",
      TRUE ~ "Country"
    )
  ) %>%
  filter(area_type == "Country") %>%
  select(-area_type)

#displaying the dimension of filtered data
dim(df_filtered)
```

```{r}
#to check the number of missing values for each column
missing_values <- colSums(is.na(df_filtered))
missing_values
```
```{r}
#if all production values is NA, set to 0
df_cleaned <- df_filtered %>%
  mutate(Production = if_else(
    Country %in%
      (
        df_filtered %>%
          group_by(Country) %>%
          summarize(
            all_zero_or_na = all(is.na(Production) |
                                   Production == 0),
            .groups = 'drop'
          ) %>%
          filter(all_zero_or_na) %>%
          pull(Country)
      ),
    0,
    Production
  ))

#if all land use values is NA, set to 0
df_cleaned <- df_cleaned %>%
  mutate(Land_Use = if_else(
    Country %in%
      (
        df_filtered %>%
          group_by(Country) %>%
          summarize(
            all_zero_or_na = all(is.na(Land_Use) |
                                   Land_Use == 0),
            .groups = 'drop'
          ) %>%
          filter(all_zero_or_na) %>%
          pull(Country)
      ),
    0,
    Land_Use
  ))

# Calculate growth rates
population_data <- df_cleaned %>%
  mutate(GrowthRate = (Population - lag(Population)) / lag(Population))

#calculating mean growth rate
average_growth_rate <- mean(population_data$GrowthRate, na.rm = TRUE)

#function to impute data based on calcualted growth rate
impute_population <- function(data, avg_growth) {
  for (i in 1:nrow(data)) {
    if (is.na(data$Population[i])) {
      previous_population <- data$Population[i - 1]  # Last known population
      data$Population[i] <- previous_population * (1 + avg_growth)  # Impute using growth rate
    }
  }
  return(data)
}

# Impute missing values
population_data <- impute_population(population_data, average_growth_rate)

#group by data to mutate the land_use for specific countries
population_data <- population_data %>%
  group_by(Country) %>%
  mutate(Land_Use = na.approx(Land_Use, na.rm = FALSE)) %>%
  ungroup()

#fill in missing values in the Land_Use column using interpolation
population_data$Land_Use <- na.approx(population_data$Land_Use)

final_df <- population_data %>%
  select(columns_of_interest)

colSums(is.na(final_df))
```
```{r}
library(patchwork)
library(corrplot)

# Correlation matrix with heatmap
cor_matrix <- cor(final_df[, c("Production", "Population", "Land_Use")], use = "complete.obs")
corrplot(cor_matrix, method = "color", addCoef.col = "black")

#to see the distribution of each column
plots <- list()
for (col in c("Population", "Production", "Land_Use")) {
  if (is.numeric(final_df[[col]])) {
    p <- ggplot(final_df, aes_string(x = col)) +
      geom_histogram(bins = 30,
                     color = "black",
                     fill = "blue") +
      labs(title = paste("Histogram of ", col),
           x = col,
           y = "Count")
    plots[[col]] <- p
  }
}
combined_plot <- wrap_plots(plots, ncol = 2)
print(combined_plot)

#since each distribution is skewed performing log transformation to improve the symmetry
copied <- final_df
plots <- list()

for (col in c("Population", "Production", "Land_Use")) {
  if (is.numeric(copied[[col]])) {
    # Filter out non-positive values
    filtered_data <- copied %>% filter(!!sym(col) > 0)
    
    # Create a new log-transformed column
    filtered_data <- filtered_data %>%
      mutate(!!sym(paste0("log_", col)) := log(!!sym(col)))
    
    # Create histogram for the log-transformed variable
    p <- ggplot(filtered_data, aes_string(x = paste0("log_", col))) +
      geom_histogram(bins = 10,
                     color = "black",
                     fill = "blue") +
      labs(
        title = paste("Histogram of log-transformed", col),
        x = paste("log-transformed ", col, sep = ""),
        y = "Count"
      ) +
      theme(plot.title = element_text(size = 12))
    
    plots[[col]] <- p
  }
}

# Combine the plots
combined_plot <- wrap_plots(plots, ncol = 2)  # Adjust ncol for layout
print(combined_plot)
```
```{r}
#scatter plot with production vs other parameters colured by country
# Create a list to store plots
plots <- list()

# Loop through each parameter and create a scatter plot
for (col in c("Population", "Land_Use")) {
  p <- ggplot(final_df,
              aes_string(x = "Production", y = col, color = "Country")) +
    geom_point() +
    labs(
      title = paste("Scatter Plot of Production vs", col, "coloured by country"),
      x = "Production",
      y = col
    ) +
    theme_minimal() +
    theme(legend.position = "none")
  
  plots[[col]] <- p  #Store the plot in the list
}

#Combine all plots into a single layout
combined_plot <- wrap_plots(plots, ncol = 1)  # Adjust ncol for layout
print(combined_plot)

#scatter plot with production vs other parameters coloured by year
#Create a list to store plots
plots <- list()

# Loop through each parameter and create a scatter plot
for (col in c("Population", "Land_Use")) {
  p <- ggplot(final_df, aes_string(x = "Production", y = col, color = "Year")) +
    geom_point() +
    labs(
      title = paste("Scatter Plot of Production vs", col, "coloured by year"),
      x = "Production",
      y = col
    ) +
    theme_minimal() +
    theme(legend.position = "none")
  
  plots[[col]] <- p  #Store the plot in the list
}

# Combine all plots into a single layout
combined_plot <- wrap_plots(plots, ncol = 1)  # Adjust ncol for layout
print(combined_plot)

#Production over time for each country
ggplot(final_df, aes(x = Year, y = Production, color = Country)) +
  geom_line(alpha = 0.7, size = 1) +
  labs(title = "Production Over Time by Country", x = "Year", y = "Population") + theme_minimal() +
  theme(legend.position = "none")

#total production by year
total_prod <- final_df %>%
  group_by(Year) %>%
  summarise(total_prod = sum(Production))

ggplot(total_prod, aes(x = Year, y = total_prod)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Total Production by Year", x = "Year", y = "Total Production") +
  theme_minimal()

#to Calculate the average of it over countries, plot against the years Discuss the trend
# Grouping by year and applying mean aggregation
grouped_prod <- final_df %>%
  group_by(Year) %>%
  summarize(Production = mean(Production, na.rm = TRUE),
            .groups = 'drop')

# Plotting a scatterplot with year vs CO2 Emission
ggplot(grouped_prod, aes(x = Production, y = Year)) +
  geom_point() +
  labs(title = 'Production vs Year', x = 'Production', y = 'Year') +
  theme_minimal()
```
```{r}
#subtract the average of that column for the country
# Assuming 'final_df' is your data frame and the columns are specified
copied_df <- final_df

# Create a list to store the plots
plots <- list()

# Looping through each column to create scatterplots
for (i in seq_along(c("Population", "Land_Use"))) {
  col1 <- c("Population", "Land_Use", "Production")[i]
  
  # Centering the data by subtracting the country average
  copied_df <- copied_df %>%
    group_by(Country) %>%
    mutate(!!col1 := get(col1) - mean(get(col1), na.rm = TRUE)) %>%
    ungroup()
  
  # Create scatter plot with production
  p <- ggplot(copied_df, aes_string(x = col1, y = "Production")) +
    geom_point(alpha = 0.7, color = 'blue') +
    labs(
      title = paste("Scatter Plot of", col1, "vs Production"),
      x = col1,
      y = "Production"
    ) +
    theme_minimal()
  plots[[i]] <- p
}

# Arrange and display the plots
combined_plot <- wrap_plots(plots, ncol = 2)  # Adjust ncol for layout
print(combined_plot)
```
```{r}
#subtract the average of that column for the year
# Assuming 'final_df' is your data frame and the columns are specified
copied_df <- final_df

# Create a list to store the plots
plots <- list()

# Looping through each column to create scatterplots
for (i in seq_along(c("Population", "Land_Use"))) {
  col1 <- c("Population", "Land_Use", "Production")[i]
  
  # Centering the data by subtracting the year average
  copied_df <- copied_df %>%
    group_by(Year) %>%
    mutate(!!col1 := get(col1) - mean(get(col1), na.rm = TRUE)) %>%
    ungroup()
  
  # Create scatter plot with production
  p <- ggplot(copied_df, aes_string(x = col1, y = "Production")) +
    geom_point(alpha = 0.7, color = 'blue') +
    labs(
      title = paste("Scatter Plot of", col1, "vs Production"),
      x = col1,
      y = "Production"
    ) +
    theme_minimal()
  plots[[i]] <- p
}

# Arrange and display the plots
combined_plot <- wrap_plots(plots, ncol = 2)  # Adjust ncol for layout
print(combined_plot)
```
```{r}
ggplot(final_df, aes(x = Country, y = Production, fill = Country)) +
  geom_boxplot() +
  labs(title = "Production by Country", x = "Country", y = "Production") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "none")

#qqplot
iqr <- IQR(final_df$Production)
lower_bound <- quantile(final_df$Production, 0.25) - 1.5 * iqr
upper_bound <- quantile(final_df$Production, 0.75) + 1.5 * iqr

no_outliers <- final_df %>%
  filter(Production >= lower_bound, Production <= upper_bound)

qqnorm(no_outliers$Production, main = "Production QQ Plot")
qqline(no_outliers$Production, col = "red")
```
```{r}
#Compare production across different countries
anova_res_country <- aov(Production ~ Country, data = final_df)
summary(anova_res_country)

#Compare production across different year
anova_res_year <- aov(Production ~ Year, data = final_df)
summary(anova_res_year)
```
```{r}
# Create a new variable for high production (e.g., > 25 million tons)
#Is there a significant association between the country of origin and high rice production levels?
#null: There is no association between the country and high rice production (the distribution of high production is the same across all countries).
data <- final_df %>%
  mutate(high_production = ifelse(Production > 25000000, "Yes", "No"))
#A p-value of p < 2.2e-16 from the Chi-Square test indicates a very strong statistical significance in the relationship between the country of origin and high rice production levels. This means that the null hypothesis can be rejected that there is no association between the two categorical variables.

# Create a contingency table
contingency_table <- table(data$Country, data$high_production)
chi_square_result <- chisq.test(contingency_table)
print(chi_square_result)

# Calculate proportions of high production for each country
country_proportions <- as.data.frame(contingency_table) %>%
  group_by(Var1) %>%  # Var1 corresponds to Country
  summarize(High_Production_Proportion = sum(Freq[Var2 == "Yes"]) / sum(Freq)) %>%
  arrange(desc(High_Production_Proportion))

# Rename the columns for clarity
colnames(country_proportions) <- c("Country", "High_Production_Proportion")

# Display the results
print(country_proportions)

# Bar plot of high production proportions by country
ggplot(country_proportions,
       aes(
         x = reorder(Country, High_Production_Proportion),
         y = High_Production_Proportion
       )) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +  # Flip coordinates for better readability
  labs(title = "Proportion of High Rice Production by Country", x = "Country", y = "Proportion of High Production") +
  theme_minimal()
```
```{r}
# Assume data is from before and after COVID-19 (e.g., 2019 vs 2020)
pre_covid <- data %>% filter(Year == 2019)
post_covid <- data %>% filter(Year == 2020)

# Independent t-test
t_test_covid <- t.test(pre_covid$Production, post_covid$Production)
print(t_test_covid)
```
```{r}
# Assume you want to compare high vs. low land use
data <- data %>%
  mutate(land_use_category = ifelse(Land_Use > median(Land_Use), "High", "Low"))

t_test_land_use <- t.test(Production ~ land_use_category, data = data)
print(t_test_land_use)
```
```{r}
# Calculate the top quartile for production in the last five years
last_five_years <- c(2020, 2019, 2018, 2017, 2016)

# Filter data for the last five years
filtered_data <- data %>%
  filter(Year %in% last_five_years)

filtered_data <- filtered_data %>%
  mutate(High_Producer = ifelse(Production > 25000000, "Yes", "No"))

# Count the number of years each country produced over 25 million tons
consistent_production_counts <- filtered_data %>%
  mutate(High_Production = ifelse(Production > 25000000, 1, 0)) %>%  # Create a binary indicator
  group_by(Country) %>%
  summarize(Consistent_Production_Years = sum(High_Production)) %>%  # Count the number of high production years
  filter(Consistent_Production_Years == 5)  # Keep only those with 5 years of high production

# Calculate the production threshold for the top quartile over the last five years
top_quartile_threshold <- filtered_data %>%
  summarize(Top_Quartile = quantile(Production, 0.75)) %>%
  pull(Top_Quartile)

# Filter the countries that are in the top quartile and have consistent production
top_quartile_countries <- consistent_production_counts %>%
  inner_join(filtered_data %>%
               group_by(Country) %>%
               summarize(Average_Production = mean(Production)),
             by = "Country") %>%
  filter(Average_Production >= top_quartile_threshold)

# Calculate improvement over the last five years for these countries
improvement_data <- filtered_data %>%
  filter(Country %in% top_quartile_countries$Country) %>%
  group_by(Country) %>%
  summarize(Improvement = last(Production) - first(Production)) %>%
  arrange(desc(Improvement))

# Get the countries with the most improvement
most_improved_country <- improvement_data %>%
  filter(Improvement == max(Improvement))  # Identify the country with the most improvement

# Print results
cat("Countries consistently producing over 25 million tons in the last five years:\n")
print(top_quartile_countries)

cat("\nCountries showing the most improvement in production:\n")
print(most_improved_country)

# Perform the t-test
t_test_result <- t.test(Production ~ High_Producer, data = filtered_data)

# Print the results of the t-test
print(t_test_result)
#There is a significant difference in average rice production between high producers and low producers.

ggplot(filtered_data, aes(x = Year, y = Production, group = Country, color = Country)) +
  geom_line() +
  labs(title = "Rice Production Over the Last Five Years",
       x = "Year", y = "Production (in tons)") +
  theme_minimal() +
  theme(legend.position = "none")

high_producers <- filtered_data %>%
  mutate(High_Producer = ifelse(Production > 25000000, "Yes", "No")) %>%
  group_by(Country) %>%
  summarize(Consistently_High = sum(High_Producer == "Yes") == 5) %>%
  filter(Consistently_High == TRUE)

# Categorize countries based on consistent high production
filtered_data <- filtered_data %>%
  mutate(High_Producer = ifelse(Country %in% high_producers$Country, "Consistent High Producer", "Others"))

#Scatter Plot to examine any relationships between production and other factors, such as land use or population.
ggplot(filtered_data, aes(x = Population, y = Production, color = High_Producer)) +
  geom_point(size = 3) +
  labs(title = "Production vs Population",
       x = "Population", y = "Production (in tons)") +
  theme_minimal()

# Calculate improvement over the five years
improvement_data <- filtered_data %>%
  group_by(Country) %>%
  summarize(Improvement = last(Production) - first(Production)) %>%
  arrange(desc(Improvement))

print(improvement_data)

# Visualize the improvement
ggplot(improvement_data, aes(x = reorder(Country, Improvement), y = Improvement, fill = Improvement > 0)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(title = "Improvement in Rice Production Over the Last Five Years",
       x = "Country", y = "Change in Production (in tons)") +
  theme_minimal()

# Create a summary of average production by category
avg_production <- filtered_data %>%
  group_by(High_Producer) %>%
  summarize(Average_Production = mean(Production, na.rm = TRUE))

# Bar plot comparing average production of consistent high producers vs others
ggplot(avg_production, aes(x = High_Producer, y = Average_Production, fill = High_Producer)) +
  geom_bar(stat = "identity", width = 0.6) +
  labs(title = "Average Rice Production: Consistent High Producers vs Others",
       x = "Category", y = "Average Production (in tons)") +
  theme_minimal() +
  scale_fill_manual(values = c("Consistent High Producer" = "blue", "Others" = "red"))
```
